services:
  mysql:
    image: mysql:8
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: esmassiva
      MYSQL_USER: esmassiva
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-esmassiva}
    ports:
      - "${LISTEN_IP:-127.0.0.1}:3309:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 5s
      timeout: 5s
      retries: 10

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: ${ADMIN_PASSWORD:-admin123}
    ports:
      - "${LISTEN_IP:-127.0.0.1}:9000:9000"
      - "${LISTEN_IP:-127.0.0.1}:9001:9001"

  nginx:
    image: nginx:latest
    volumes:
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf
      - htpasswd-cache:/etc/nginx/.htpasswd
    ports:
      - "${LISTEN_IP:-127.0.0.1}:8000:8000"
    depends_on:
      app:
        condition: service_healthy
      adminer:
        condition: service_started
      htpasswd-generator:
        condition: service_completed_successfully

  htpasswd-generator:
    image: httpd:alpine
    command: >
      sh -c "htpasswd -bc /htpasswd/htpasswd admin ${ADMIN_PASSWORD:-admin123} &&
             chmod 644 /htpasswd/htpasswd &&
             echo 'Generated htpasswd file with username: admin'"
    volumes:
      - htpasswd-cache:/htpasswd
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}

  adminer:
    image: adminer:latest
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      ADMINER_DEFAULT_SERVER: mysql
    ports:
      - "${LISTEN_IP:-127.0.0.1}:8080:8080"

  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
      minio:
        condition: service_started
    command: >
      /usr/bin/tini -- bash -c '
        echo "Installing dependencies..."
        pnpm install

        echo "Pushing database schema..."
        pnpm db:push

        echo "Seeding database..."
        pnpm db:seed || echo "Seed already exists or failed, continuing..."

        if [ "$NODE_ENV" = "development" ]; then
          echo "Running in development mode"
          PORT=3000 pnpm dev
        else
          echo "Building for production..."
          pnpm build

          echo "Verifying build output..."
          if [ -d ".output" ]; then
            echo "✓ Build output directory found"
            echo "Checking structure:"
            ls -la .output/ | head -10
            echo ""
            echo "Looking for processed HTML:"
            find .output -name "*.html" -type f 2>/dev/null | head -5 || echo "No HTML files found"
            echo ""
            echo "Checking for client build:"
            find .output -type d -name "*client*" 2>/dev/null | head -5 || echo "No client directory found"
          else
            echo "❌ ERROR: .output directory not found after build"
            echo "Build may have failed. Check logs above for errors."
            exit 1
          fi

          echo ""
          echo "Running in production mode"
          PORT=3000 pnpm start
        fi
      '
    working_dir: /app
    volumes:
      - ../:/app
      - node-modules-cache:/app/node_modules
    ports:
      - "${LISTEN_IP:-127.0.0.1}:3000:3000"
    environment:
      - DATABASE_URL=mysql://esmassiva:${MYSQL_PASSWORD:-esmassiva}@mysql:3306/esmassiva
      - NODE_ENV=${NODE_ENV:-development}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - BASE_URL=${BASE_URL:-}
      - BASE_PATH=${BASE_PATH:-/esmassiva-web}
      - PORT=3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

volumes:
  mysql-data:
  minio-data:
  htpasswd-cache:
  node-modules-cache:
